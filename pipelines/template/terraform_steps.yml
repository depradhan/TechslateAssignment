parameters:
  - name: ringName
    type: string

steps:
  - task: TerraformInstaller@1
    displayName: 'Install Terraform Tool'
    inputs:
      terraformVersion: 'latest'
      
  - task: AzureCLI@2
    displayName: "Terraform Init"
    inputs:
      azureSubscription: 'InsightApp'
      scriptType: 'batch'
      scriptLocation: 'inlineScript'
      inlineScript: 'terraform init -backend-config="./backend/backend-${{parameters.ringName}}.tfvars"'
      addSpnToEnvironment: true
      workingDirectory: '$(System.DefaultWorkingDirectory)/terraform'

  - task: AzureCLI@2
    displayName: "Terraform validate"
    inputs:
      azureSubscription: 'InsightApp'
      scriptType: 'batch'
      scriptLocation: 'inlineScript'
      inlineScript: 'terraform validate -var-file="./variables/${{parameters.ringName}}.tfvars"'
      addSpnToEnvironment: true
      workingDirectory: '$(System.DefaultWorkingDirectory)/terraform'


  - task: AzureCLI@2
    displayName: "Terraform plan"
    inputs:
      azureSubscription: 'InsightApp'
      scriptType: 'batch'
      scriptLocation: 'inlineScript'
      inlineScript: 'terraform plan -var-file="./variables/${{parameters.ringName}}.tfvars"'
      addSpnToEnvironment: true
      workingDirectory: '$(System.DefaultWorkingDirectory)/terraform'

  - task: AzureCLI@2
    displayName: "Terraform apply"
    inputs:
      azureSubscription: 'InsightApp'
      scriptType: 'batch'
      scriptLocation: 'inlineScript'
      inlineScript: 'terraform plan -var-file="./variables/${{parameters.ringName}}.tfvars"'
      addSpnToEnvironment: true
      workingDirectory: '$(System.DefaultWorkingDirectory)/terraform'
